# 画像編集システム

## プロジェクト概要
- **名前**: 画像編集システム
- **目標**: キャンペーン画像の割引率と価格を自動的に変更するWebアプリケーション
- **主な機能**: 
  - **複数画像の一括処理** 🆕
  - **カスタムキャンペーン名入力** 🆕
  - **画像URL入力対応** 🆕
  - 画像アップロード（ドラッグ&ドロップ対応）
  - 割引率の入力と価格の自動計算
  - NanoBanana AIによる画像生成
  - 生成画像の個別/一括ダウンロード

## 現在完成している機能

### ✅ 基本機能
1. **複数画像入力機能** 🆕
   - **方法1: ファイルアップロード**
     - 1枚または複数枚の画像を同時にアップロード
     - ドラッグ&ドロップ対応
     - **自動画像最適化機能** 🆕
       - 大きな画像（高解像度）は自動的にリサイズ（最大幅1920px）
       - 品質90%で圧縮してファイルサイズを削減
       - Base64エンコードエラーを防止
     - 画像プレビュー機能
     - 個別削除・一括クリア機能
     - PNG, JPG, JPEG形式対応
   - **方法2: 画像URL入力** 🆕
     - 画像URLを直接入力（複数対応）
     - 大きなファイルのアップロード問題を解決
     - 例: https://www.genspark.ai/api/files/s/gnHscP8A

2. **価格計算機能**
   - 割引率入力（0〜100%）
   - リアルタイム価格自動計算
   - コムレギュラー（元価格: ¥4,400）
   - コムハード（元価格: ¥4,950）

3. **キャンペーン設定機能** 🆕
   - 大感謝祭 限定キャンペーン
   - お買い物マラソン限定キャンペーン
   - **カスタムキャンペーン名入力**（独自のキャンペーン名を設定可能）

4. **AI画像一括生成** 🆕
   - NanoBanana Pro統合
   - 複数画像の順次生成
   - 生成進捗表示
   - 元画像のレイアウト維持
   - 数値部分のみ変更
   - 高品質な画像出力

5. **画像ダウンロード機能** 🆕
   - 個別ダウンロード
   - **一括ダウンロード機能**
   - ファイル名自動設定

## 機能エントリーURI

### Web UI
- **メインページ**: `/`
  - 画像アップロード、割引率入力、画像生成UI

### API エンドポイント
- **POST `/api/calculate`**
  - リクエスト: `{ "discountRate": 20 }`
  - レスポンス: 計算された価格情報
  ```json
  {
    "discountRate": 20,
    "prices": {
      "regular": { "original": 4400, "discounted": 3520 },
      "hard": { "original": 4950, "discounted": 3960 }
    }
  }
  ```

- **POST `/api/generate-image`**
  - リクエスト: FormData (image, discountRate, campaignType, customCampaignName)
  - レスポンス: 画像生成用プロンプトとパラメータ（単一画像用）

- **POST `/api/generate-batch`** 🆕
  - リクエスト: FormData (image_0, image_1, ..., discountRate, campaignType, customCampaignName)
  - レスポンス: 複数画像生成用プロンプトとパラメータ（ファイルアップロード用）
  ```json
  {
    "success": true,
    "count": 2,
    "images": [
      { "prompt": "...", "imageUrl": "data:image/jpeg;base64,...", "originalName": "image1.jpg" },
      { "prompt": "...", "imageUrl": "data:image/jpeg;base64,...", "originalName": "image2.jpg" }
    ],
    "prices": { "regular": 3520, "hard": 3960 },
    "discountRate": 20,
    "campaignTitle": "大感謝祭 限定キャンペーン"
  }
  ```

- **POST `/api/generate-batch-url`** 🆕
  - リクエスト: JSON ({ imageUrls: ["url1", "url2"], discountRate, campaignType, customCampaignName })
  - レスポンス: 複数画像生成用プロンプトとパラメータ（URL指定用）
  ```json
  {
    "success": true,
    "count": 2,
    "images": [
      { "prompt": "...", "imageUrl": "https://...", "originalName": "image_1" },
      { "prompt": "...", "imageUrl": "https://...", "originalName": "image_2" }
    ],
    "prices": { "regular": 3520, "hard": 3960 },
    "discountRate": 20,
    "campaignTitle": "大感謝祭 限定キャンペーン"
  }
  ```

## URLs
- **開発環境**: https://3000-iirb1svvzh1pxbdjfucbh-ea026bf9.sandbox.novita.ai
- **本番環境**: デプロイ後に更新予定
- **GitHub**: https://github.com/kyo10310415/image-editing

## データアーキテクチャ

### データモデル
- **元画像**: Base64エンコード、FormDataとして送信（複数対応）
- **割引率**: Number型（0-100の範囲）
- **キャンペーン名**: String型（カスタム入力対応）
- **価格情報**: Object型
  ```typescript
  {
    regular: { original: number, discounted: number },
    hard: { original: number, discounted: number }
  }
  ```

### ストレージサービス
- **フロントエンド**: ブラウザメモリ（複数画像一時保存）
- **バックエンド**: Cloudflare Workers（ステートレス）
- **AI生成**: NanoBanana Pro API（外部サービス）

### データフロー

#### ファイルアップロードモード
1. ユーザーが複数画像をアップロード → ブラウザメモリに配列として保存
2. キャンペーンタイプを選択 → カスタムの場合は独自名称を入力
3. 割引率を入力 → `/api/calculate`で価格計算
4. 「画像を生成」クリック → `/api/generate-batch`で複数プロンプト生成（Base64変換）
5. フロントエンドがNanoBanana APIを順次呼び出し（進捗表示）
6. 生成画像をグリッド表示 → 個別または一括ダウンロード可能

#### 画像URL入力モード 🆕
1. ユーザーが画像URLを入力（複数行対応）
2. キャンペーンタイプと割引率を設定
3. 「画像を生成」クリック → `/api/generate-batch-url`でプロンプト生成
4. フロントエンドがNanoBanana APIを順次呼び出し（URLを直接使用）
5. 生成画像をグリッド表示 → ダウンロード可能

## 使い方ガイド

### 基本的な使用方法

#### 方法1: ファイルアップロード
1. **「ファイルをアップロード」を選択**
2. **画像をアップロード**
   - 1枚または複数枚の画像をドラッグ&ドロップまたはクリックして選択
   - **大きな画像は自動的に最適化されます**（最大幅1920px、品質90%）
   - 選択した画像のプレビューが表示されます
   - 不要な画像は個別に削除可能
   
3. **設定を入力**
   - キャンペーンタイプを選択
     - 大感謝祭 限定キャンペーン
     - お買い物マラソン限定キャンペーン
     - **カスタム**（独自のキャンペーン名を入力）
   - 割引率を入力（例: 20, 25, 30）
   - 価格が自動計算されます

4. **画像を生成**
   - 「画像を生成」ボタンをクリック
   - AI画像生成が開始（複数画像の場合は順次処理）
   - 進捗状況が表示されます（例: 画像 2/3 を生成中...）
   
5. **画像をダウンロード**
   - 生成された画像がグリッド形式で表示
   - 各画像を個別にダウンロード
   - または「すべてダウンロード」ボタンで一括ダウンロード

**💡 自動画像最適化について:**
- 元の画像サイズ: 例 5MB → 最適化後: 約1MB以下
- 元の解像度: 例 4000x3000 → 最適化後: 1920x1440
- 処理速度が大幅に向上し、エラーが発生しにくくなります
- ブラウザコンソールで詳細なリサイズ情報を確認できます

#### 方法2: 画像URL入力 🆕（推奨）
1. **「画像URLを入力」を選択**
2. **画像URLを入力**
   - テキストエリアに画像URLを1行に1つずつ入力
   - 例:
     ```
     https://www.genspark.ai/api/files/s/gnHscP8A
     https://www.genspark.ai/api/files/s/dUVrMxmY
     ```
   - 複数のURLを改行で区切って入力可能
   
3. **設定と生成**
   - キャンペーンタイプと割引率を設定
   - 「画像を生成」ボタンをクリック
   - 以降は方法1と同じ流れ

**💡 URL入力モードの利点:**
- 大きな画像ファイルでもエラーが発生しない
- アップロード時間が不要
- 外部ホスティングされた画像を直接使用可能

### 使用例

#### 例1: 単一画像の処理
- キャンペーン: 大感謝祭
- 割引率: 20%
- 結果: コムレギュラー ¥3,520、コムハード ¥3,960

#### 例2: 複数画像の一括処理 🆕
- 画像: 3枚アップロード
- キャンペーン: カスタム「春のセール限定キャンペーン」
- 割引率: 25%
- 結果: 3枚すべてが同じ設定で生成され、一括ダウンロード可能

#### 例3: 割引率別の比較画像作成
- 同じ画像を3回アップロード
- それぞれ異なる割引率（15%, 20%, 25%）で生成
- 比較用の画像セットが完成

## デプロイメント

### 現在のステータス
- **ローカル開発**: ✅ 動作中
- **GitHub**: ✅ 連携済み（https://github.com/kyo10310415/image-editing）
- **本番デプロイ**: 準備可能

### 技術スタック
- **フロントエンド**: HTML, TailwindCSS, JavaScript (Vanilla)
- **バックエンド**: Hono + TypeScript
- **デプロイ**: Cloudflare Pages対応
- **AI画像生成**: NanoBanana Pro API
- **開発環境**: PM2 (Process Manager)

### ローカル開発手順
```bash
# ビルド
npm run build

# 開発サーバー起動
pm2 start ecosystem.config.cjs

# サービス確認
curl http://localhost:3000

# ログ確認
pm2 logs webapp --nostream

# サービス再起動
pm2 restart webapp
```

### GitHubへのプッシュ
```bash
# 変更をコミット
git add .
git commit -m "機能追加: 複数画像一括処理とカスタムキャンペーン名"

# リモートリポジトリへプッシュ
git push -f origin main
```

### Cloudflare Pagesデプロイ手順
```bash
# Cloudflare Pages にデプロイ
npm run deploy:prod
```

## 新機能の詳細 🆕

### 1. 複数画像一括処理
- **機能**: 最大複数枚の画像を同時にアップロード・処理
- **メリット**: 
  - 同じ設定で複数のキャンペーン画像を一度に生成
  - 作業時間を大幅に短縮
  - 一貫性のある画像セットを作成

### 2. カスタムキャンペーン名入力
- **機能**: キャンペーンタイプで「カスタム」を選択すると、独自のキャンペーン名を入力可能
- **例**:
  - 春のセール限定キャンペーン
  - 週末特価キャンペーン
  - 新商品発売記念キャンペーン
  - など、自由に設定可能

### 3. 画像URL入力機能 🆕
- **機能**: 画像ファイルをアップロードする代わりに、画像URLを直接入力
- **メリット**:
  - **大きなファイルサイズの問題を解決**: Base64エンコードによるサイズ制限を回避
  - **高速処理**: ファイルアップロードとエンコードの時間を削減
  - **外部リソース活用**: 既にホスティングされている画像を直接使用可能
- **使い方**:
  1. 「画像URLを入力」ラジオボタンを選択
  2. テキストエリアに画像URLを入力（1行に1URL）
  3. 複数のURLを改行で区切って入力可能
- **対応URL例**:
  - https://www.genspark.ai/api/files/s/gnHscP8A
  - https://www.genspark.ai/api/files/s/dUVrMxmY
  - その他の公開画像URL

### 4. 自動画像最適化機能 🆕
- **機能**: ローカルからアップロードされた大きな画像を自動的に最適化
- **処理内容**:
  - **リサイズ**: 最大幅1920pxにリサイズ（アスペクト比維持）
  - **圧縮**: 品質90%でJPEG/PNG圧縮
  - **ファイルサイズ削減**: 通常5MB以上の画像が1MB以下に
- **メリット**:
  - Base64エンコードエラーを完全に防止
  - 処理速度の大幅な向上
  - API制限を回避
  - ユーザーは何もする必要なし（完全自動）
- **詳細情報**:
  - ブラウザコンソールで元のサイズと最適化後のサイズを確認可能
  - 解像度変換の詳細もログ出力
  - 元の画像より小さい場合は最適化をスキップ
- **例**:
  - 春のセール限定キャンペーン
  - 週末特価キャンペーン
  - 新商品発売記念キャンペーン
  - など、自由に設定可能

## 推奨される次のステップ

### 機能拡張
1. ~~**画像履歴機能**: 過去に生成した画像を保存・管理~~ （将来実装予定）
2. ~~**カスタムキャンペーン名**: ユーザーが独自のキャンペーン名を入力~~ ✅ **実装済み**
3. ~~**バッチ処理**: 複数の割引率で一括生成~~ ✅ **実装済み**
4. **プレビュー機能**: 画像生成前にプレビュー表示

### 技術改善
1. **Cloudflare D1統合**: 生成履歴をデータベースに保存
2. **R2 Storage統合**: 生成画像を永続化
3. **認証機能**: ユーザーログインと個人履歴管理
4. **キャッシュ機能**: 同じ設定の画像を再生成しない

### デプロイ
1. ✅ **GitHub連携**: リポジトリ作成とコードプッシュ（完了）
2. **Cloudflare Pagesデプロイ**: 本番環境公開
3. **カスタムドメイン**: 独自ドメインの設定

## 更新履歴

### v2.2.0 - 2026-02-07 🆕
- ✨ **自動画像最適化機能**を追加（ローカルアップロード時）
- 🔧 大きな画像を自動的に最大幅1920px、品質90%に最適化
- 💄 UI改善: 画像最適化の説明を追加
- 🐛 修正: 大きなファイルのBase64エンコードエラーを完全に解決
- 📝 ドキュメント更新: 画像最適化機能の詳細を追加
- 🎯 ファイルサイズ削減による処理速度の大幅な向上

### v2.1.0 - 2026-02-07
- ✨ **画像URL入力機能**を追加（大きなファイル問題を解決）
- 🔧 新しいAPIエンドポイント `/api/generate-batch-url` を追加
- 💄 UI改善: ファイルアップロードとURL入力の切り替え機能
- 🐛 修正: Base64エンコードのスタックオーバーフロー問題を解決
- 📝 ドキュメント更新: URL入力モードの使い方を追加
- 🎨 エラーハンドリングの改善

### v2.0.0 - 2026-02-07
- ✨ **複数画像一括処理機能**を追加
- ✨ **カスタムキャンペーン名入力機能**を追加
- 🔧 新しいAPIエンドポイント `/api/generate-batch` を追加
- 💄 UI改善: グリッドレイアウトで複数画像表示
- 💄 進捗表示機能を追加
- 🎨 一括ダウンロード機能を追加
- 📝 使い方ガイドを更新

### v1.0.0 - 2026-02-07
- 🎉 初回リリース
- 基本的な画像アップロードと生成機能

## 最終更新日
2026-02-07
